import xml.etree.ElementTree as ET
import pandas as pd
import re
from datetime import date, timedelta
import os

# ==========================================================================
# âš™ï¸ í™˜ê²½ ì„¤ì • (Configuration)
# ==========================================================================

# ğŸŒŸ ë§ˆìŠ¤í‚¹ ë¬¸ì ì„¤ì •: ' ' (ê³µë°±) ë˜ëŠ” '_' (ì–¸ë”ë°”) ì¤‘ ì„ íƒ
MASKING_CHAR = '_'

# 1. ëŒ€ìƒ ê¸°ê°„ ì„¤ì •: íƒœì¡° 2ë…„ (1393ë…„)
# ì‹œì‘ ë‚ ì§œ (í¬í•¨)
START_DATE_KOREAN = "íƒœì¡° 2ë…„ 3ì›” 1ì¼"
START_DATE_ISO = date(1393, 3, 1)

# ì¢…ë£Œ ë‚ ì§œ (ë¯¸í¬í•¨, 7ì›” 31ì¼ê¹Œì§€ ì¶”ì¶œí•˜ë ¤ë©´ 8ì›” 1ì¼ì„ ì§€ì •)
END_DATE_KOREAN = "íƒœì¡° 2ë…„ 7ì›” 31ì¼"
EXCLUSIVE_END_DATE_ISO = date(1393, 8, 1)

# ì²˜ë¦¬í•  XML íŒŒì¼ ëª©ë¡ (íŒŒì¼ ê²½ë¡œëŠ” í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
XML_FILES_TO_PROCESS = ['2nd_waa_102.xml']

# ìµœì¢… ì¶œë ¥ íŒŒì¼ëª…
OUTPUT_FILENAME = 'a020701_í•œë¬¸ì›ë¬¸_ìµœì¢…ë§ˆìŠ¤í‚¹_.tsv'

# ==========================================================================
# ğŸ”§ í•µì‹¬ í•¨ìˆ˜ (Core Functions)
# ==========================================================================

def get_target_dates_id_list(start_date, exclusive_end_date):
    """
    ì£¼ì–´ì§„ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” 7ìë¦¬ ì‹¤ë¡ ë‚ ì§œ ID (YYMMDDD, ì˜ˆ: '0204001') ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    - íƒœì¡° 2ë…„ (02)ì— ëŒ€í•´ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.
    """
    date_id_list = set()
    current_date = start_date
    # exclusive_end_date ì§ì „ ë‚ ì§œê¹Œì§€ ë°˜ë³µ
    while current_date < exclusive_end_date:
        # 7ìë¦¬ ID í˜•ì‹: 02 (íƒœì¡° 2ë…„) + MM (ì›” 2ìë¦¬) + DDD (ì¼ 3ìë¦¬)
        sillok_date_id = f"02{current_date.month:02d}{current_date.day:03d}"
        date_id_list.add(sillok_date_id)
        current_date += timedelta(days=1)
    return date_id_list

def parse_xml_for_sillok_data(file_path, target_date_ids, masking_char):
    """
    XML íŒŒì¼ì—ì„œ ì§€ì •ëœ ë‚ ì§œ ë²”ìœ„ì˜ ê¸°ì‚¬ë¥¼ ì¶”ì¶œí•˜ê³ , í•œë¬¸ ì›ë¬¸ì˜ <index> ë¶€ë¶„ì„ ë§ˆìŠ¤í‚¹í•©ë‹ˆë‹¤.
    """
    extracted_data = []

    # 1. XML íŒŒì¼ ë¡œë“œ ë° ì˜¤ë¥˜ ì²˜ë¦¬
    try:
        tree = ET.parse(file_path)
        root = tree.getroot()
        print(f"\nâœ… íŒŒì¼ ë¡œë“œ ì„±ê³µ: {file_path}")
    except FileNotFoundError:
        print(f"\nâŒ ì˜¤ë¥˜: íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”: {file_path}")
        return []
    except ET.ParseError:
        print(f"\nâŒ ì˜¤ë¥˜: XML íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ êµ¬ì¡°ê°€ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: {file_path}")
        return []

    print("--- ë‚ ì§œ í•„í„°ë§ ë° í…ìŠ¤íŠ¸ ë§ˆìŠ¤í‚¹ ì§„í–‰ ì¤‘ ---")

    # 2. ëª¨ë“  ê¸°ì‚¬(level5) ë°˜ë³µ ì²˜ë¦¬
    for article in root.findall('.//level5'):
        article_id = article.get('id')

        # ID ìœ íš¨ì„± ê²€ì‚¬ (IDê°€ ì—†ê±°ë‚˜, ë‚ ì§œ ë¶€ë¶„ ì¶”ì¶œì´ ë¶ˆê°€ëŠ¥í•œ ì§§ì€ IDëŠ” ê±´ë„ˆëœ€)
        if not article_id or len(article_id) < 12:
            continue

        # IDì—ì„œ 7ìë¦¬ ë‚ ì§œ ë¶€ë¶„ ì¶”ì¶œ (YYMMDDD)
        date_id_seven_digits = article_id[5:12]

        # 3. ë‚ ì§œ ë²”ìœ„ í•„í„°ë§
        if date_id_seven_digits in target_date_ids:

            # 4. ê¸°ì‚¬ ì œëª© ì¶”ì¶œ
            title_element = article.find('./front/biblioData/title/mainTitle')
            title = title_element.text.strip() if title_element is not None and title_element.text else "ì œëª© ì—†ìŒ"

            # 5. í•œë¬¸ ì›ë¬¸ ì¶”ì¶œ ë° ë§ˆìŠ¤í‚¹ ì²˜ë¦¬
            paragraph_element = article.find('./text/content/paragraph')
            chinese_text = ""

            if paragraph_element is not None:
                # <paragraph> íƒœê·¸ì™€ ê·¸ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ ë¬¸ìì—´ë¡œ ë³€í™˜
                raw_text = ET.tostring(paragraph_element, encoding='unicode')

                # ğŸŒŸ ë§ˆìŠ¤í‚¹ ë¡œì§: <index...> íƒœê·¸ì™€ ê·¸ ì•ˆì˜ ë‚´ìš©(í•œì ì£¼ì„) ì „ì²´ë¥¼ ë§ˆìŠ¤í‚¹ ë¬¸ìë¡œ ì¹˜í™˜
                # re.DOTALL: . ë¬¸ìê°€ ê°œí–‰ë¬¸ì(\n)ë„ í¬í•¨í•˜ë„ë¡ ì„¤ì •í•˜ì—¬ ë‹¤ì¤‘ ë¼ì¸ ë§¤ì¹­ ê°€ëŠ¥
                cleaned_text = re.sub(r'<index[^>]*>.*?</index>', masking_char, raw_text, flags=re.DOTALL)

                # <annotation> íƒœê·¸ ë° ë‚´ìš© ì œê±° (ì¼ë°˜ì ì¸ XML ì£¼ì„ íƒœê·¸)
                cleaned_text = re.sub(r'<annotation[^>]*>.*?</annotation>', '', cleaned_text, flags=re.DOTALL)

                # <paragraph> íƒœê·¸ ìì²´ ì œê±° ë° ê¸°íƒ€ ë¶ˆí•„ìš”í•œ XML/HTML ì—”í‹°í‹° ì •ë¦¬
                # ".*?:/" ë¶€ë¶„ì€ ì‹¤ë¡ ë°ì´í„°ì˜ íŠ¹ì • íŒ¨í„´ìœ¼ë¡œ ë³´ì„ (ì œê±°)
                cleaned_text = re.sub(r'<paragraph[^>]*>|.*?:/|</paragraph>', '', cleaned_text)
                cleaned_text = re.sub(r'&lt;.*?&gt;', '', cleaned_text)

                # í…ìŠ¤íŠ¸ ì •ë¦¬: ì—¬ëŸ¬ ê°œì˜ ê³µë°±ì´ë‚˜ ë§ˆìŠ¤í‚¹ ë¬¸ìê°€ ì—°ì†ë  ê²½ìš° í•˜ë‚˜ë¡œ í•©ì¹˜ê³ , ì•ë’¤ ê³µë°± ì œê±°
                chinese_text = re.sub(r'\s+', ' ', cleaned_text).strip() # ê³µë°± ì •ë¦¬
                # ì§€ì •ëœ ë§ˆìŠ¤í‚¹ ë¬¸ìê°€ ì—°ì†ë  ê²½ìš° í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°
                chinese_text = re.sub(f'{re.escape(masking_char)}+', masking_char, chinese_text).strip()

            # 6. ê²°ê³¼ ì €ì¥ (IDì—ì„œ ë‚ ì§œ ì •ë³´ë¥¼ ë‹¤ì‹œ ì¶”ì¶œí•˜ì—¬ 'ë°œí–‰ì¼' í•„ë“œ ìƒì„±)
            try:
                # ID í˜•ì‹: sillok.taejo.02.04.001 (5:12ê°€ ë‚ ì§œ)
                year_part = int(article_id[5:7])
                month_part = int(article_id[7:9])
                day_part = int(article_id[9:12])
            except ValueError:
                # ë‚ ì§œ íŒŒíŠ¸ê°€ ìˆ«ìê°€ ì•„ë‹ ê²½ìš°ë¥¼ ëŒ€ë¹„
                year_part, month_part, day_part = 'N/A', 'N/A', 'N/A'


            extracted_data.append({
                "ID": article_id,
                "ë°œí–‰ì¼": f"íƒœì¡° {year_part}ë…„ {month_part}ì›” {day_part}ì¼",
                "ê¸°ì‚¬ì œëª©": title,
                "ë³¸ë¬¸ë‚´ìš©_í•œë¬¸_ì›ë¬¸_ë§ˆìŠ¤í‚¹": chinese_text
            })

    return extracted_data

# ==========================================================================
# ğŸš€ ë©”ì¸ ì‹¤í–‰ ë¸”ë¡ (Main Execution Block)
# ==========================================================================

if __name__ == "__main__":
    print("="*50)
    print("ğŸ‘‘ ì¡°ì„ ì™•ì¡°ì‹¤ë¡ (íƒœì¡° 2ë…„) XML ë°ì´í„° ì¶”ì¶œ ë° ë§ˆìŠ¤í‚¹ í”„ë¡œê·¸ë¨ ğŸ‘‘")
    print("="*50)

    # 1. ëŒ€ìƒ ë‚ ì§œ ID ë¦¬ìŠ¤íŠ¸ ìƒì„±
    target_dates_list = get_target_dates_id_list(START_DATE_ISO, EXCLUSIVE_END_DATE_ISO)

    print(f"â­ ì¶”ì¶œ ëŒ€ìƒ ê¸°ê°„: {START_DATE_KOREAN}ë¶€í„° {END_DATE_KOREAN}ê¹Œì§€ ({len(target_dates_list)}ì¼)")
    print(f"â­ ë§ˆìŠ¤í‚¹ ë¬¸ì: '{MASKING_CHAR}'")
    print("-" * 50)

    final_results = []

    # 2. ì§€ì •ëœ ëª¨ë“  XML íŒŒì¼ ì²˜ë¦¬
    for file in XML_FILES_TO_PROCESS:
        results = parse_xml_for_sillok_data(file, set(target_dates_list), MASKING_CHAR)
        final_results.extend(results)

    # 3. ë°ì´í„°í”„ë ˆì„ ìƒì„± ë° ì •ë¦¬
    if final_results:
        df_final = pd.DataFrame(final_results)

        # ID ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ê¸°ì‚¬ ì œê±° ë° ì •ë ¬
        initial_count = len(df_final)
        df_final.drop_duplicates(subset=['ID'], inplace=True)
        final_count = len(df_final)

        if initial_count != final_count:
            print(f"\nâš ï¸ ì¤‘ë³µ ê¸°ì‚¬ {initial_count - final_count}ê°œ ì œê±°ë¨.")

        df_final.sort_values(by='ID', inplace=True)

        # 4. TSV íŒŒì¼ë¡œ ì €ì¥
        try:
            df_final.to_csv(OUTPUT_FILENAME, index=False, encoding='utf-8-sig', sep='\t', quoting=1)

            print("\n" + "="*50)
            print(f"ğŸ‰ ì´ {len(df_final)}ê°œì˜ ê¸°ì‚¬ ì¶”ì¶œ ë° ì €ì¥ ì™„ë£Œ!")
            print(f"**ê²°ê³¼ íŒŒì¼ëª…: {OUTPUT_FILENAME}** (ì¸ì½”ë”©: UTF-8-sig, êµ¬ë¶„ì: Tab)")
            print("="*50)

            # ì¶”ì¶œëœ ë°ì´í„°ì˜ ìƒìœ„ 5ê°œ ì¶œë ¥
            print("\n--- ì¶”ì¶œ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° ---")
            print(df_final.head().to_markdown(index=False)) # Markdown í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì—¬ ê°€ë…ì„± ë†’ì„

        except Exception as e:
            print(f"\nâŒ ì˜¤ë¥˜: ê²°ê³¼ íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ({e})")

    else:
        print("\nìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        print("ğŸ’¡ íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆê±°ë‚˜ íŒŒì¼ ë‚´ì— ì§€ì •ëœ ê¸°ê°„ì˜ ê¸°ì‚¬ê°€ ì—†ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
